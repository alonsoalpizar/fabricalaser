<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarifas | Admin FabricaLaser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../admin.css">
  <style>
    .field-calculated {
      background: var(--bg-warm, #EDEAE4) !important;
      color: var(--text-muted, #8A8681) !important;
      cursor: not-allowed;
      border-style: dashed !important;
      font-weight: 500;
    }
    .field-calculated-hint {
      font-size: 0.6875rem;
      color: var(--text-muted, #8A8681);
      margin-top: 0.25rem;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .field-calculated-hint::before {
      content: '⚡';
    }
    /* Modal scroll fix */
    #itemModal .modal {
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    #itemModal .modal-body {
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1 class="content-title">Tarifas por Tecnologia</h1>
          <div class="content-breadcrumb">
            <a href="/admin/">Dashboard</a>
            <span>/</span>
            <span>Configuracion</span>
            <span>/</span>
            <span>Tarifas</span>
          </div>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nueva Tarifa
        </button>
      </header>

      <div class="content-body">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Tarifas de Corte y Grabado</h3>
          </div>
          <div class="card-body">
            <p class="text-muted" style="padding: 0 1.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
              Cada tecnologia tiene tarifas por hora para grabado y corte. Los costos por minuto se calculan automaticamente.
            </p>
            <div id="dataTable">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" id="itemModal">
    <div class="modal large">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Nueva Tarifa</h3>
        <button class="modal-close" onclick="closeModal('itemModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="itemForm" onsubmit="saveItem(event)">
        <div class="modal-body">
          <input type="hidden" id="itemId" value="">

          <div class="form-group">
            <label class="form-label">Tecnologia *</label>
            <select class="form-select" id="itemTechnology" required>
              <option value="">Seleccione tecnologia...</option>
            </select>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Tarifa Operador Grabado (₡/hora) *</label>
              <input type="number" class="form-input" id="itemEngraveRate" required min="0" step="1" placeholder="Ej: 6180">
            </div>

            <div class="form-group">
              <label class="form-label">Tarifa Operador Corte (₡/hora) *</label>
              <input type="number" class="form-input" id="itemCutRate" required min="0" step="1" placeholder="Ej: 7210">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Tarifa Operador Diseno (₡/hora)</label>
              <input type="number" class="form-input" id="itemDesignRate" min="0" step="1" placeholder="Ej: 7725">
              <span class="form-hint" style="font-style: normal;">Informativo — no afecta el calculo actual</span>
            </div>

            <div class="form-group">
              <label class="form-label">Setup Fee (₡)</label>
              <input type="number" class="form-input" id="itemSetupFee" min="0" step="1" placeholder="Ej: 2575">
              <span class="form-hint">Cargo unico por trabajo</span>
            </div>

            <div class="form-group">
              <label class="form-label">Margen (%)</label>
              <input type="number" class="form-input" id="itemMargin" min="0" max="100" step="1" placeholder="Ej: 40">
              <span class="form-hint">Porcentaje de ganancia</span>
            </div>
          </div>

          <!-- Costos Fijos por Máquina -->
          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <h4 style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
              Costos Fijos de esta Máquina (₡/mes)
            </h4>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem;">
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Electricidad</label>
                <input type="number" class="form-input" id="itemElectricidad" min="0" step="100" placeholder="15450">
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Mantenimiento</label>
                <input type="number" class="form-input" id="itemMantenimiento" min="0" step="100" placeholder="25750">
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Depreciación</label>
                <input type="number" class="form-input" id="itemDepreciacion" min="0" step="100" placeholder="96990">
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Seguro</label>
                <input type="number" class="form-input" id="itemSeguro" min="0" step="100" placeholder="12875">
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Consumibles</label>
                <input type="number" class="form-input" id="itemConsumibles" min="0" step="100" placeholder="20600">
              </div>
            </div>
            <p class="form-hint" style="margin-top: 0.5rem;">
              Estos costos se suman al overhead global del taller para calcular el costo por minuto.
            </p>
          </div>

          <!-- Campos Calculados (readonly) -->
          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <h4 style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
              Valores Calculados
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Costos Fijos/Hora (₡)</label>
                <input type="text" class="form-input field-calculated" id="itemOverheadHora" readonly value="0">
                <span class="field-calculated-hint">Global + maquina</span>
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Costo/Min Grabado (₡)</label>
                <input type="text" class="form-input field-calculated" id="itemCostMinEngrave" readonly value="0">
                <span class="field-calculated-hint">(Tarifa + Fijos) / 60</span>
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size: 0.75rem;">Costo/Min Corte (₡)</label>
                <input type="text" class="form-input field-calculated" id="itemCostMinCut" readonly value="0">
                <span class="field-calculated-hint">(Tarifa + Fijos) / 60</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Estado</label>
            <select class="form-select" id="itemActive">
              <option value="true">Activo</option>
              <option value="false">Inactivo</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('itemModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar eliminacion</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p>Esta seguro de eliminar esta tarifa?</p>
        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">Esta accion no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>

  <script src="../admin.js"></script>
  <script>
    const ENDPOINT = '/admin/tech-rates';
    let items = [];
    let technologies = [];
    let deleteItemId = null;

    // Overhead global (se carga desde system_config)
    let overheadGlobalHora = 0;
    let horasTrabajoMes = 120;

    async function loadData() {
      const container = document.getElementById('dataTable');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const [ratesData, techData, configData] = await Promise.all([
          apiGet(ENDPOINT),
          apiGet('/admin/technologies'),
          apiGet('/admin/system-config')
        ]);

        items = ratesData.data || [];
        technologies = techData.data || [];

        // Extraer overhead global desde system_config
        const configs = configData.data || [];
        const alquiler = parseFloat(configs.find(c => c.config_key === 'overhead_alquiler')?.config_value || 0);
        const internet = parseFloat(configs.find(c => c.config_key === 'overhead_internet')?.config_value || 0);
        horasTrabajoMes = parseFloat(configs.find(c => c.config_key === 'horas_trabajo_mes')?.config_value || 120);
        overheadGlobalHora = (alquiler + internet) / horasTrabajoMes;

        populateTechSelect();
        renderTable();
      } catch (err) {
        console.error('Failed to load data:', err);
        container.innerHTML = `<div class="empty-state"><p class="text-error">Error: ${err.message}</p></div>`;
      }
    }

    // Recalcular campos derivados en tiempo real
    function recalcularCostos() {
      const electricidad = parseFloat(document.getElementById('itemElectricidad').value) || 0;
      const mantenimiento = parseFloat(document.getElementById('itemMantenimiento').value) || 0;
      const depreciacion = parseFloat(document.getElementById('itemDepreciacion').value) || 0;
      const seguro = parseFloat(document.getElementById('itemSeguro').value) || 0;
      const consumibles = parseFloat(document.getElementById('itemConsumibles').value) || 0;

      // Overhead maquina por hora
      const totalMaquinaMes = electricidad + mantenimiento + depreciacion + seguro + consumibles;
      const overheadMaquinaHora = totalMaquinaMes / horasTrabajoMes;

      // Total costos fijos por hora
      const costosFijosHora = overheadGlobalHora + overheadMaquinaHora;

      // Actualizar campo Costos Fijos por Hora
      document.getElementById('itemOverheadHora').value = costosFijosHora.toFixed(2);

      // Leer tarifas operador
      const tarifaGrabado = parseFloat(document.getElementById('itemEngraveRate').value) || 0;
      const tarifaCorte = parseFloat(document.getElementById('itemCutRate').value) || 0;

      // Calcular cost per minute
      const costPerMinEngrave = (tarifaGrabado + costosFijosHora) / 60;
      const costPerMinCut = (tarifaCorte + costosFijosHora) / 60;

      // Actualizar campos calculados
      document.getElementById('itemCostMinEngrave').value = costPerMinEngrave.toFixed(2);
      document.getElementById('itemCostMinCut').value = costPerMinCut.toFixed(2);
    }

    // Escuchar cambios en campos que afectan el calculo
    function setupRecalculoListeners() {
      const camposQueAfectan = [
        'itemElectricidad', 'itemMantenimiento', 'itemDepreciacion',
        'itemSeguro', 'itemConsumibles',
        'itemEngraveRate', 'itemCutRate'
      ];
      camposQueAfectan.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', recalcularCostos);
      });
    }

    function populateTechSelect() {
      const techSelect = document.getElementById('itemTechnology');
      techSelect.innerHTML = '<option value="">Seleccione tecnologia...</option>' +
        technologies.filter(t => t.is_active).map(t =>
          `<option value="${t.id}">${t.name || t.nombre}</option>`
        ).join('');
    }

    function getTechName(id) {
      const tech = technologies.find(t => t.id === id);
      return tech ? (tech.name || tech.nombre) : '-';
    }

    function renderTable() {
      const container = document.getElementById('dataTable');

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <p>No hay tarifas configuradas</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Tecnologia</th>
              <th>Grabado/hr</th>
              <th>Corte/hr</th>
              <th>Overhead/mes</th>
              <th>Margen</th>
              <th>Setup</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${items.map(item => {
              const overheadMes = (item.electricidad_mes || 0) + (item.mantenimiento_mes || 0) +
                                  (item.depreciacion_mes || 0) + (item.seguro_mes || 0) +
                                  (item.consumibles_mes || 0);
              return `
              <tr>
                <td class="font-semibold">${item.technology?.name || getTechName(item.technology_id)}</td>
                <td class="font-mono">₡${Math.round(item.engrave_rate_hour || 0).toLocaleString('es-CR')}</td>
                <td class="font-mono">₡${Math.round(item.cut_rate_hour || 0).toLocaleString('es-CR')}</td>
                <td class="font-mono text-muted" title="Electricidad + Mantenimiento + Depreciación + Seguro + Consumibles">
                  ₡${Math.round(overheadMes).toLocaleString('es-CR')}
                </td>
                <td class="font-semibold">${((item.margin_percent || 0) * 100).toFixed(0)}%</td>
                <td class="font-mono">₡${Math.round(item.setup_fee || 0).toLocaleString('es-CR')}</td>
                <td>
                  <span class="status-badge ${item.is_active ? 'approved' : 'rejected'}" style="font-size: 0.6875rem;">
                    ${item.is_active ? 'Activo' : 'Inactivo'}
                  </span>
                </td>
                <td>
                  <div style="display: flex; gap: 0.25rem;">
                    <button class="btn btn-ghost btn-sm" onclick="editItem(${item.id})" title="Editar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="deleteItem(${item.id})" title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Nueva Tarifa';
      document.getElementById('itemForm').reset();
      document.getElementById('itemId').value = '';
      document.getElementById('itemTechnology').disabled = false;
      document.getElementById('itemMargin').value = '40';
      document.getElementById('itemDesignRate').value = '7725';
      // Defaults para costos fijos por máquina
      document.getElementById('itemElectricidad').value = '15450';
      document.getElementById('itemMantenimiento').value = '25750';
      document.getElementById('itemDepreciacion').value = '96990';
      document.getElementById('itemSeguro').value = '12875';
      document.getElementById('itemConsumibles').value = '20600';
      openModal('itemModal');
      recalcularCostos();
    }

    function editItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalTitle').textContent = 'Editar Tarifa';
      document.getElementById('itemId').value = item.id;
      document.getElementById('itemTechnology').value = item.technology_id;
      document.getElementById('itemTechnology').disabled = true;
      document.getElementById('itemEngraveRate').value = item.engrave_rate_hour || 0;
      document.getElementById('itemCutRate').value = item.cut_rate_hour || 0;
      document.getElementById('itemDesignRate').value = item.design_rate_hour || 7725;
      document.getElementById('itemSetupFee').value = item.setup_fee || 0;
      document.getElementById('itemMargin').value = ((item.margin_percent || 0.4) * 100).toFixed(0);
      document.getElementById('itemActive').value = item.is_active ? 'true' : 'false';
      // Costos fijos por máquina
      document.getElementById('itemElectricidad').value = item.electricidad_mes || 0;
      document.getElementById('itemMantenimiento').value = item.mantenimiento_mes || 0;
      document.getElementById('itemDepreciacion').value = item.depreciacion_mes || 0;
      document.getElementById('itemSeguro').value = item.seguro_mes || 0;
      document.getElementById('itemConsumibles').value = item.consumibles_mes || 0;
      openModal('itemModal');
      recalcularCostos();
    }

    async function saveItem(e) {
      e.preventDefault();

      const id = document.getElementById('itemId').value;
      const isNew = !id;

      const engraveRate = parseFloat(document.getElementById('itemEngraveRate').value) || 0;
      const cutRate = parseFloat(document.getElementById('itemCutRate').value) || 0;
      const designRate = parseFloat(document.getElementById('itemDesignRate').value) || 7725;
      const marginPct = (parseFloat(document.getElementById('itemMargin').value) || 40) / 100;

      // Costos fijos por máquina
      const electricidad = parseFloat(document.getElementById('itemElectricidad').value) || 0;
      const mantenimiento = parseFloat(document.getElementById('itemMantenimiento').value) || 0;
      const depreciacion = parseFloat(document.getElementById('itemDepreciacion').value) || 0;
      const seguro = parseFloat(document.getElementById('itemSeguro').value) || 0;
      const consumibles = parseFloat(document.getElementById('itemConsumibles').value) || 0;

      const body = {
        technology_id: parseInt(document.getElementById('itemTechnology').value),
        engrave_rate_hour: engraveRate,
        cut_rate_hour: cutRate,
        design_rate_hour: designRate,
        setup_fee: parseFloat(document.getElementById('itemSetupFee').value) || 0,
        margin_percent: marginPct,
        electricidad_mes: electricidad,
        mantenimiento_mes: mantenimiento,
        depreciacion_mes: depreciacion,
        seguro_mes: seguro,
        consumibles_mes: consumibles,
        is_active: document.getElementById('itemActive').value === 'true'
      };

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      try {
        if (isNew) {
          await apiPost(ENDPOINT, body);
          showToast('Tarifa creada', 'success');
        } else {
          await apiPut(`${ENDPOINT}/${id}`, body);
          showToast('Tarifa actualizada', 'success');
        }

        closeModal('itemModal');
        loadData();
      } catch (err) {
        console.error('Failed to save:', err);
        showToast(err.message || 'Error al guardar', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      }
    }

    function deleteItem(id) {
      deleteItemId = id;
      openModal('deleteModal');
    }

    async function confirmDelete() {
      if (!deleteItemId) return;

      try {
        await apiDelete(`${ENDPOINT}/${deleteItemId}`);
        showToast('Tarifa eliminada', 'success');
        closeModal('deleteModal');
        loadData();
      } catch (err) {
        console.error('Failed to delete:', err);
        showToast(err.message || 'Error al eliminar', 'error');
      }

      deleteItemId = null;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const ready = await initAdmin('rates');
      if (ready) {
        setupRecalculoListeners();
        loadData();
      }
    });
  </script>
</body>
</html>
