<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuracion General | Admin FabricaLaser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../admin.css">
  <style>
    .config-grid {
      display: grid;
      gap: 1.5rem;
    }

    .category-section {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .category-header {
      padding: 1rem 1.5rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .category-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .category-icon svg {
      width: 20px;
      height: 20px;
    }

    .category-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .category-subtitle {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .config-list {
      padding: 0;
    }

    .config-item {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-light);
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .config-info {
      min-width: 0;
    }

    .config-key {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.8125rem;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }

    .config-description {
      font-size: 0.875rem;
      color: var(--text);
    }

    .config-value-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .config-value-display {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text);
      background: var(--bg);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      min-width: 80px;
      text-align: right;
    }

    .config-value-input {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text);
      background: var(--white);
      padding: 0.5rem 1rem;
      border: 1px solid var(--accent);
      border-radius: 6px;
      min-width: 80px;
      width: 120px;
      text-align: right;
    }

    .config-value-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .config-edit-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .config-edit-btn:hover {
      background: var(--bg-warm);
      color: var(--accent);
    }

    .config-edit-btn.save {
      color: var(--success);
    }

    .config-edit-btn.save:hover {
      background: var(--success-bg);
    }

    .config-edit-btn.cancel {
      color: var(--error);
    }

    .config-edit-btn.cancel:hover {
      background: var(--error-bg);
    }

    .category-speeds .category-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .category-times .category-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .category-complexity .category-icon { background: rgba(234, 179, 8, 0.1); color: #eab308; }
    .category-pricing .category-icon { background: rgba(184, 84, 62, 0.1); color: var(--accent); }
    .category-quotes .category-icon { background: rgba(147, 51, 234, 0.1); color: #9333ea; }
  </style>
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1 class="content-title">Configuracion General</h1>
          <div class="content-breadcrumb">
            <a href="/admin/">Dashboard</a>
            <span>/</span>
            <span>Configuracion</span>
            <span>/</span>
            <span>General</span>
          </div>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nueva Configuracion
        </button>
      </header>

      <div class="content-body">
        <div class="config-grid" id="configGrid">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" id="itemModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Nueva Configuracion</h3>
        <button class="modal-close" onclick="closeModal('itemModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="itemForm" onsubmit="saveItem(event)">
        <div class="modal-body">
          <input type="hidden" id="itemId" value="">

          <div class="form-group">
            <label class="form-label">Clave de Configuracion *</label>
            <input type="text" class="form-input" id="itemKey" required placeholder="Ej: base_cut_speed">
            <span class="form-hint">Identificador unico en snake_case</span>
          </div>

          <div class="form-group">
            <label class="form-label">Valor *</label>
            <input type="text" class="form-input" id="itemValue" required placeholder="Ej: 20">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Tipo de Valor *</label>
              <select class="form-select" id="itemValueType">
                <option value="string">Texto</option>
                <option value="number">Numero</option>
                <option value="boolean">Booleano</option>
                <option value="json">JSON</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Categoria *</label>
              <select class="form-select" id="itemCategory">
                <option value="speeds">Velocidades</option>
                <option value="times">Tiempos</option>
                <option value="complexity">Complejidad</option>
                <option value="pricing">Precios</option>
                <option value="quotes">Cotizaciones</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Descripcion</label>
            <textarea class="form-textarea" id="itemDescription" placeholder="Descripcion de la configuracion..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('itemModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar eliminacion</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p>Esta seguro de eliminar <strong id="deleteItemName"></strong>?</p>
        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">Esta accion no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>

  <script src="../admin.js"></script>
  <script>
    const ENDPOINT = '/admin/system-config';
    const ENTITY_NAME = 'Configuracion';
    let items = [];
    let deleteItemId = null;
    let editingId = null;

    const categoryIcons = {
      speeds: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>',
      times: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
      complexity: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
      pricing: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
      quotes: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>'
    };

    const categoryLabels = {
      speeds: { title: 'Velocidades', subtitle: 'Velocidades de corte y grabado' },
      times: { title: 'Tiempos', subtitle: 'Tiempos de configuracion y preparacion' },
      complexity: { title: 'Complejidad', subtitle: 'Umbrales de aprobacion automatica' },
      pricing: { title: 'Precios', subtitle: 'Configuracion de precios base' },
      quotes: { title: 'Cotizaciones', subtitle: 'Parametros de cotizaciones' }
    };

    async function loadItems() {
      const container = document.getElementById('configGrid');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const data = await apiGet(ENDPOINT);
        items = data.data || [];
        renderGrid();
      } catch (err) {
        console.error('Failed to load items:', err);
        container.innerHTML = `<div class="empty-state"><p class="text-error">Error: ${err.message}</p></div>`;
      }
    }

    function groupByCategory(items) {
      const groups = {};
      items.forEach(item => {
        if (!groups[item.category]) {
          groups[item.category] = [];
        }
        groups[item.category].push(item);
      });
      return groups;
    }

    function renderGrid() {
      const container = document.getElementById('configGrid');

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <p>No hay configuraciones</p>
          </div>
        `;
        return;
      }

      const groups = groupByCategory(items);
      const categoryOrder = ['speeds', 'times', 'complexity', 'pricing', 'quotes'];

      let html = '';
      categoryOrder.forEach(category => {
        if (groups[category] && groups[category].length > 0) {
          const label = categoryLabels[category] || { title: category, subtitle: '' };
          html += `
            <div class="category-section category-${category}">
              <div class="category-header">
                <div class="category-icon">${categoryIcons[category] || ''}</div>
                <div>
                  <div class="category-title">${label.title}</div>
                  <div class="category-subtitle">${label.subtitle}</div>
                </div>
              </div>
              <div class="config-list">
                ${groups[category].map(item => renderConfigItem(item)).join('')}
              </div>
            </div>
          `;
        }
      });

      // Render any uncategorized items
      Object.keys(groups).forEach(category => {
        if (!categoryOrder.includes(category)) {
          html += `
            <div class="category-section">
              <div class="category-header">
                <div class="category-icon">${categoryIcons[category] || ''}</div>
                <div>
                  <div class="category-title">${category}</div>
                  <div class="category-subtitle">Otras configuraciones</div>
                </div>
              </div>
              <div class="config-list">
                ${groups[category].map(item => renderConfigItem(item)).join('')}
              </div>
            </div>
          `;
        }
      });

      container.innerHTML = html;
    }

    function renderConfigItem(item) {
      const isEditing = editingId === item.id;
      return `
        <div class="config-item" data-id="${item.id}">
          <div class="config-info">
            <div class="config-key">${item.config_key}</div>
            <div class="config-description">${item.description || '-'}</div>
          </div>
          <div class="config-value-wrapper">
            ${isEditing ? `
              <input type="text" class="config-value-input" id="edit-value-${item.id}" value="${item.config_value}" onkeydown="handleEditKeydown(event, ${item.id})">
              <button class="config-edit-btn save" onclick="saveInlineEdit(${item.id})" title="Guardar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
              <button class="config-edit-btn cancel" onclick="cancelInlineEdit()" title="Cancelar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            ` : `
              <span class="config-value-display">${item.config_value}</span>
              <button class="config-edit-btn" onclick="startInlineEdit(${item.id})" title="Editar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="config-edit-btn" onclick="deleteItem(${item.id}, '${item.config_key}')" title="Eliminar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            `}
          </div>
        </div>
      `;
    }

    function startInlineEdit(id) {
      editingId = id;
      renderGrid();
      setTimeout(() => {
        const input = document.getElementById(`edit-value-${id}`);
        if (input) {
          input.focus();
          input.select();
        }
      }, 50);
    }

    function cancelInlineEdit() {
      editingId = null;
      renderGrid();
    }

    function handleEditKeydown(event, id) {
      if (event.key === 'Enter') {
        event.preventDefault();
        saveInlineEdit(id);
      } else if (event.key === 'Escape') {
        cancelInlineEdit();
      }
    }

    async function saveInlineEdit(id) {
      const input = document.getElementById(`edit-value-${id}`);
      if (!input) return;

      const newValue = input.value.trim();
      if (!newValue) {
        showToast('El valor no puede estar vacio', 'error');
        return;
      }

      try {
        await apiPut(`${ENDPOINT}/${id}`, { config_value: newValue });
        showToast('Configuracion actualizada', 'success');
        editingId = null;
        loadItems();
      } catch (err) {
        console.error('Failed to save:', err);
        showToast(err.message || 'Error al guardar', 'error');
      }
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = `Nueva ${ENTITY_NAME}`;
      document.getElementById('itemForm').reset();
      document.getElementById('itemId').value = '';
      document.getElementById('itemKey').disabled = false;
      document.getElementById('itemValueType').disabled = false;
      document.getElementById('itemCategory').disabled = false;
      openModal('itemModal');
    }

    async function saveItem(e) {
      e.preventDefault();

      const id = document.getElementById('itemId').value;
      const isNew = !id;

      const body = {
        config_key: document.getElementById('itemKey').value,
        config_value: document.getElementById('itemValue').value,
        value_type: document.getElementById('itemValueType').value,
        category: document.getElementById('itemCategory').value,
        description: document.getElementById('itemDescription').value || null
      };

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      try {
        if (isNew) {
          await apiPost(ENDPOINT, body);
          showToast(`${ENTITY_NAME} creada`, 'success');
        } else {
          await apiPut(`${ENDPOINT}/${id}`, body);
          showToast(`${ENTITY_NAME} actualizada`, 'success');
        }

        closeModal('itemModal');
        loadItems();
      } catch (err) {
        console.error('Failed to save:', err);
        showToast(err.message || 'Error al guardar', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      }
    }

    function deleteItem(id, name) {
      deleteItemId = id;
      document.getElementById('deleteItemName').textContent = name || 'este elemento';
      openModal('deleteModal');
    }

    async function confirmDelete() {
      if (!deleteItemId) return;

      try {
        await apiDelete(`${ENDPOINT}/${deleteItemId}`);
        showToast(`${ENTITY_NAME} eliminada`, 'success');
        closeModal('deleteModal');
        loadItems();
      } catch (err) {
        console.error('Failed to delete:', err);
        showToast(err.message || 'Error al eliminar', 'error');
      }

      deleteItemId = null;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const ready = await initAdmin('general');
      if (ready) loadItems();
    });
  </script>
</body>
</html>
