<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Costos de Material | Admin FabricaLaser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../admin.css">
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1 class="content-title">Costos de Material</h1>
          <div class="content-breadcrumb">
            <a href="/admin/">Dashboard</a>
            <span>/</span>
            <span>Configuracion</span>
            <span>/</span>
            <span>Costos de Material</span>
          </div>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nuevo Costo
        </button>
      </header>

      <div class="content-body">
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Precios de Materia Prima</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <label style="font-size: 0.875rem; color: var(--text-secondary);">Filtrar:</label>
              <select class="form-select" id="filterMaterial" onchange="filterByMaterial()" style="width: 200px;">
                <option value="">Todos los materiales</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <p class="text-muted" style="padding: 0 1.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
              Costos de laminas de materia prima. El costo por mm2 se calcula automaticamente: cost_per_mm2 = sheet_cost / (width x height).
              Lamina estandar: 1220 x 2440 mm = 2,976,800 mm2.
            </p>
            <div id="dataTable">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" id="itemModal">
    <div class="modal large">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Nuevo Costo de Material</h3>
        <button class="modal-close" onclick="closeModal('itemModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="itemForm" onsubmit="saveItem(event)">
        <div class="modal-body">
          <input type="hidden" id="itemId" value="">

          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Material *</label>
              <select class="form-select" id="itemMaterial" required>
                <option value="">Seleccione material</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Grosor (mm) *</label>
              <input type="number" class="form-input" id="itemThickness" required min="0" step="0.1" value="3" placeholder="Ej: 3">
            </div>
          </div>

          <div class="form-group" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">Datos de Lamina (para calculo automatico)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Costo Lamina (CRC)</label>
                <input type="number" class="form-input" id="itemSheetCost" min="0" step="0.01" placeholder="Ej: 15000">
                <span class="form-hint">Precio de una lamina completa</span>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Ancho (mm)</label>
                <input type="number" class="form-input" id="itemSheetWidth" min="0" step="0.01" value="1220" placeholder="1220">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Alto (mm)</label>
                <input type="number" class="form-input" id="itemSheetHeight" min="0" step="0.01" value="2440" placeholder="2440">
              </div>
            </div>
            <div id="calcPreview" style="margin-top: 0.75rem; font-size: 0.8125rem; color: var(--text-secondary); display: none;">
              Costo calculado: <strong id="calcResult">-</strong>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Costo por mm2 (CRC) *</label>
              <input type="number" class="form-input" id="itemCostPerMm2" required min="0" step="0.00000001" placeholder="0.00503935">
              <span class="form-hint">Si llena datos de lamina arriba, se calcula automaticamente</span>
            </div>

            <div class="form-group">
              <label class="form-label">Porcentaje de Merma *</label>
              <input type="number" class="form-input" id="itemWastePct" required min="0" max="1" step="0.01" value="0.15" placeholder="0.15">
              <span class="form-hint">0.15 = 15% de desperdicio</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="itemNotes" placeholder="Notas sobre el material, proveedor, etc."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Estado</label>
            <select class="form-select" id="itemActive">
              <option value="true">Activo</option>
              <option value="false">Inactivo</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('itemModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar eliminacion</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p>Esta seguro de eliminar <strong id="deleteItemName"></strong>?</p>
        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">Esta accion no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>

  <script src="../admin.js"></script>
  <script>
    const ENDPOINT = '/admin/material-costs';
    let items = [];
    let materials = [];
    let deleteItemId = null;
    let filterMaterialId = '';

    async function loadMaterials() {
      try {
        const data = await apiGet('/admin/materials');
        materials = data.data || [];

        // Populate material selectors
        const filterSelect = document.getElementById('filterMaterial');
        const formSelect = document.getElementById('itemMaterial');

        materials.forEach(m => {
          filterSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
          formSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
        });
      } catch (err) {
        console.error('Failed to load materials:', err);
      }
    }

    async function loadItems() {
      const container = document.getElementById('dataTable');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        let url = ENDPOINT;
        if (filterMaterialId) {
          url += `?material_id=${filterMaterialId}`;
        }
        const data = await apiGet(url);
        items = data.data || [];
        renderTable();
      } catch (err) {
        console.error('Failed to load items:', err);
        container.innerHTML = `<div class="empty-state"><p class="text-error">Error: ${err.message}</p></div>`;
      }
    }

    function filterByMaterial() {
      filterMaterialId = document.getElementById('filterMaterial').value;
      loadItems();
    }

    function getMaterialName(id) {
      const m = materials.find(mat => mat.id === id);
      return m ? m.name : `Material #${id}`;
    }

    function formatCRC(val) {
      if (val === null || val === undefined) return '-';
      return new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(val);
    }

    function formatCostPerMm2(val) {
      if (!val) return '-';
      return `${val.toFixed(8)} /mm2`;
    }

    function formatPct(val) {
      if (val === null || val === undefined) return '-';
      return `${(val * 100).toFixed(1)}%`;
    }

    function renderTable() {
      const container = document.getElementById('dataTable');

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <p>No hay costos de material configurados</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Material</th>
              <th>Grosor</th>
              <th>Costo/mm2</th>
              <th>Merma</th>
              <th>Costo Lamina</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${items.map(item => `
              <tr>
                <td>
                  <div class="font-semibold">${getMaterialName(item.material_id)}</div>
                  <div class="text-muted" style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.notes || ''}</div>
                </td>
                <td>
                  <span class="font-mono font-semibold">${item.thickness} mm</span>
                </td>
                <td>
                  <span class="font-mono text-accent">${formatCostPerMm2(item.cost_per_mm2)}</span>
                </td>
                <td>
                  <span class="font-mono">${formatPct(item.waste_pct)}</span>
                </td>
                <td>
                  <div style="font-size: 0.875rem;">
                    ${item.sheet_cost ? formatCRC(item.sheet_cost) : '-'}
                  </div>
                  ${item.sheet_width_mm && item.sheet_height_mm ?
                    `<div class="text-muted" style="font-size: 0.75rem;">${item.sheet_width_mm} x ${item.sheet_height_mm} mm</div>` : ''}
                </td>
                <td>
                  <span class="status-badge ${item.is_active ? 'approved' : 'rejected'}" style="font-size: 0.6875rem;">
                    ${item.is_active ? 'Activo' : 'Inactivo'}
                  </span>
                </td>
                <td>
                  <div style="display: flex; gap: 0.25rem;">
                    <button class="btn btn-ghost btn-sm" onclick="recalculate(${item.id})" title="Recalcular costo/mm2">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"></path>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                      </svg>
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="editItem(${item.id})" title="Editar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="deleteItem(${item.id}, '${getMaterialName(item.material_id)} ${item.thickness}mm')" title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Nuevo Costo de Material';
      document.getElementById('itemForm').reset();
      document.getElementById('itemId').value = '';
      document.getElementById('itemMaterial').value = '';
      document.getElementById('itemThickness').value = '3';
      document.getElementById('itemSheetWidth').value = '1220';
      document.getElementById('itemSheetHeight').value = '2440';
      document.getElementById('itemWastePct').value = '0.15';
      document.getElementById('calcPreview').style.display = 'none';
      openModal('itemModal');
    }

    function editItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalTitle').textContent = 'Editar Costo de Material';
      document.getElementById('itemId').value = item.id;
      document.getElementById('itemMaterial').value = item.material_id || '';
      document.getElementById('itemThickness').value = item.thickness || 3;
      document.getElementById('itemSheetCost').value = item.sheet_cost || '';
      document.getElementById('itemSheetWidth').value = item.sheet_width_mm || 1220;
      document.getElementById('itemSheetHeight').value = item.sheet_height_mm || 2440;
      document.getElementById('itemCostPerMm2').value = item.cost_per_mm2 || '';
      document.getElementById('itemWastePct').value = item.waste_pct || 0.15;
      document.getElementById('itemNotes').value = item.notes || '';
      document.getElementById('itemActive').value = item.is_active ? 'true' : 'false';

      updateCalcPreview();
      openModal('itemModal');
    }

    function updateCalcPreview() {
      const sheetCost = parseFloat(document.getElementById('itemSheetCost').value) || 0;
      const sheetWidth = parseFloat(document.getElementById('itemSheetWidth').value) || 0;
      const sheetHeight = parseFloat(document.getElementById('itemSheetHeight').value) || 0;

      const preview = document.getElementById('calcPreview');
      const result = document.getElementById('calcResult');

      if (sheetCost > 0 && sheetWidth > 0 && sheetHeight > 0) {
        const area = sheetWidth * sheetHeight;
        const costPerMm2 = sheetCost / area;
        result.textContent = `${formatCRC(sheetCost)} / (${sheetWidth} x ${sheetHeight}) = ${costPerMm2.toFixed(8)} /mm2`;
        preview.style.display = 'block';

        // Auto-fill cost_per_mm2
        document.getElementById('itemCostPerMm2').value = costPerMm2.toFixed(8);
      } else {
        preview.style.display = 'none';
      }
    }

    // Add event listeners for auto-calculation
    document.getElementById('itemSheetCost').addEventListener('input', updateCalcPreview);
    document.getElementById('itemSheetWidth').addEventListener('input', updateCalcPreview);
    document.getElementById('itemSheetHeight').addEventListener('input', updateCalcPreview);

    async function saveItem(e) {
      e.preventDefault();

      const id = document.getElementById('itemId').value;
      const isNew = !id;

      const body = {
        material_id: parseInt(document.getElementById('itemMaterial').value),
        thickness: parseFloat(document.getElementById('itemThickness').value) || 0,
        cost_per_mm2: parseFloat(document.getElementById('itemCostPerMm2').value) || 0,
        waste_pct: parseFloat(document.getElementById('itemWastePct').value) || 0.15,
        notes: document.getElementById('itemNotes').value || null,
        is_active: document.getElementById('itemActive').value === 'true'
      };

      // Optional sheet data
      const sheetCost = parseFloat(document.getElementById('itemSheetCost').value);
      const sheetWidth = parseFloat(document.getElementById('itemSheetWidth').value);
      const sheetHeight = parseFloat(document.getElementById('itemSheetHeight').value);

      if (sheetCost > 0) body.sheet_cost = sheetCost;
      if (sheetWidth > 0) body.sheet_width_mm = sheetWidth;
      if (sheetHeight > 0) body.sheet_height_mm = sheetHeight;

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      try {
        if (isNew) {
          await apiPost(ENDPOINT, body);
          showToast('Costo de material creado', 'success');
        } else {
          await apiPut(`${ENDPOINT}/${id}`, body);
          showToast('Costo de material actualizado', 'success');
        }

        closeModal('itemModal');
        loadItems();
      } catch (err) {
        console.error('Failed to save:', err);
        showToast(err.message || 'Error al guardar', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      }
    }

    async function recalculate(id) {
      try {
        const result = await apiPost(`${ENDPOINT}/${id}/recalculate`, {});
        showToast(result.data?.message || 'Costo recalculado', 'success');
        loadItems();
      } catch (err) {
        console.error('Failed to recalculate:', err);
        showToast(err.message || 'Error al recalcular', 'error');
      }
    }

    function deleteItem(id, name) {
      deleteItemId = id;
      document.getElementById('deleteItemName').textContent = name || 'este costo';
      openModal('deleteModal');
    }

    async function confirmDelete() {
      if (!deleteItemId) return;

      try {
        await apiDelete(`${ENDPOINT}/${deleteItemId}`);
        showToast('Costo de material eliminado', 'success');
        closeModal('deleteModal');
        loadItems();
      } catch (err) {
        console.error('Failed to delete:', err);
        showToast(err.message || 'Error al eliminar', 'error');
      }

      deleteItemId = null;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const ready = await initAdmin('material-costs');
      if (ready) {
        await loadMaterials();
        loadItems();
      }
    });
  </script>
</body>
</html>
