<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios | Admin FabricaLaser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1 class="content-title">Gestion de Usuarios</h1>
          <div class="content-breadcrumb">
            <a href="/admin/">Dashboard</a>
            <span>/</span>
            <span>Usuarios</span>
          </div>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nuevo Usuario
        </button>
      </header>

      <!-- Filters -->
      <div class="filters-bar">
        <div class="search-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input type="text" id="searchInput" placeholder="Buscar por nombre, cedula o email..." oninput="handleSearch()">
        </div>
        <select class="filter-select" id="roleFilter" onchange="loadUsers()">
          <option value="">Todos los roles</option>
          <option value="admin">Admin</option>
          <option value="user">Usuario</option>
        </select>
        <select class="filter-select" id="statusFilter" onchange="loadUsers()">
          <option value="">Todos los estados</option>
          <option value="true">Activo</option>
          <option value="false">Inactivo</option>
        </select>
      </div>

      <div class="content-body">
        <div class="card">
          <div class="card-body">
            <div id="usersTable">
              <div class="loading">
                <div class="spinner"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit User Modal -->
  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Nuevo Usuario</h3>
        <button class="modal-close" onclick="closeModal('userModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="userForm" onsubmit="saveUser(event)">
        <div class="modal-body">
          <input type="hidden" id="userId" value="">

          <div class="form-group">
            <label class="form-label">Cedula *</label>
            <input type="text" class="form-input" id="userCedula" required
                   pattern="[0-9]{9,12}" title="Cedula debe tener 9-12 digitos"
                   placeholder="Ej: 123456789">
            <span class="form-hint">Fisica (9 digitos) o Juridica (10-12 digitos)</span>
          </div>

          <div class="form-group">
            <label class="form-label">Nombre completo *</label>
            <input type="text" class="form-input" id="userName" required placeholder="Nombre del usuario">
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="userEmail" placeholder="correo@ejemplo.com">
          </div>

          <div class="form-group">
            <label class="form-label">Telefono</label>
            <input type="tel" class="form-input" id="userPhone" placeholder="8888-8888">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Rol *</label>
              <select class="form-select" id="userRole" required>
                <option value="user">Usuario</option>
                <option value="admin">Administrador</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Estado</label>
              <select class="form-select" id="userActive">
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
              </select>
            </div>
          </div>

          <div class="form-group" id="passwordGroup">
            <label class="form-label">Contrasena</label>
            <input type="password" class="form-input" id="userPassword" placeholder="Dejar vacio para no cambiar">
            <span class="form-hint" id="passwordHint">Minimo 6 caracteres</span>
          </div>

          <div class="form-group">
            <label class="form-label">Cuota de cotizaciones</label>
            <input type="number" class="form-input" id="userQuota" min="0" value="3" placeholder="3">
            <span class="form-hint">Cotizaciones permitidas por mes</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar eliminacion</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p>Esta seguro de eliminar al usuario <strong id="deleteUserName"></strong>?</p>
        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">Esta accion no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>

  <script src="admin.js"></script>
  <script>
    // ================================================
    // STATE
    // ================================================
    let usersData = { users: [], total: 0, page: 1, limit: 15 };
    let deleteUserId = null;
    let searchTimeout = null;

    // ================================================
    // LOAD USERS
    // ================================================
    async function loadUsers(page = 1) {
      const container = document.getElementById('usersTable');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const search = document.getElementById('searchInput').value;
        const role = document.getElementById('roleFilter').value;
        const active = document.getElementById('statusFilter').value;

        let url = `/admin/users?page=${page}&limit=${usersData.limit}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (role) url += `&role=${role}`;
        if (active) url += `&is_active=${active}`;

        const data = await apiGet(url);
        usersData = {
          users: data.data?.users || [],
          total: data.data?.total || 0,
          page: page,
          limit: usersData.limit
        };

        renderUsersTable();
      } catch (err) {
        console.error('Failed to load users:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p class="text-error">Error al cargar usuarios: ${err.message}</p>
          </div>
        `;
      }
    }

    function handleSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => loadUsers(1), 300);
    }

    function renderUsersTable() {
      const container = document.getElementById('usersTable');
      const { users, total, page, limit } = usersData;

      if (users.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
            </svg>
            <p>No se encontraron usuarios</p>
          </div>
        `;
        return;
      }

      const totalPages = Math.ceil(total / limit);

      container.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Cedula</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Cuota</th>
              <th>Estado</th>
              <th>Registro</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${users.map(u => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="sidebar-avatar" style="width: 36px; height: 36px; font-size: 0.75rem;">
                      ${getInitials(u.nombre)}
                    </div>
                    <div>
                      <div class="font-semibold">${truncate(u.nombre || 'Sin nombre', 25)}</div>
                      <div class="text-muted" style="font-size: 0.75rem;">${u.telefono || '-'}</div>
                    </div>
                  </div>
                </td>
                <td class="font-mono">${u.cedula || '-'}</td>
                <td>${u.email || '-'}</td>
                <td>
                  <span class="status-badge ${u.role === 'admin' ? 'reviewed' : 'approved'}" style="font-size: 0.6875rem;">
                    ${u.role === 'admin' ? 'Admin' : 'Usuario'}
                  </span>
                </td>
                <td>
                  <span class="${(u.quotes_used || 0) >= (u.quote_limit || 3) ? 'text-error' : ''}">
                    ${u.quotes_used || 0}/${u.quote_limit || 3}
                  </span>
                </td>
                <td>
                  <span class="status-badge ${u.is_active ? 'approved' : 'rejected'}" style="font-size: 0.6875rem;">
                    ${u.is_active ? 'Activo' : 'Inactivo'}
                  </span>
                </td>
                <td class="text-muted">${formatDateShort(u.created_at)}</td>
                <td>
                  <div style="display: flex; gap: 0.25rem;">
                    <button class="btn btn-ghost btn-sm" onclick="editUser(${u.id})" title="Editar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="deleteUser(${u.id}, '${(u.nombre || '').replace(/'/g, "\\'")}')" title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        ${totalPages > 1 ? renderPaginationHTML(page, totalPages) : ''}
      `;
    }

    function renderPaginationHTML(current, total) {
      let buttons = [];

      buttons.push(`<button class="pagination-btn" ${current === 1 ? 'disabled' : ''} onclick="loadUsers(${current - 1})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>`);

      const maxVisible = 5;
      let start = Math.max(1, current - Math.floor(maxVisible / 2));
      let end = Math.min(total, start + maxVisible - 1);
      if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);

      for (let i = start; i <= end; i++) {
        buttons.push(`<button class="pagination-btn ${i === current ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`);
      }

      buttons.push(`<button class="pagination-btn" ${current === total ? 'disabled' : ''} onclick="loadUsers(${current + 1})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>`);

      return `
        <div class="pagination">
          ${buttons.join('')}
          <span class="pagination-info">Pagina ${current} de ${total}</span>
        </div>
      `;
    }

    function getInitials(name) {
      if (!name) return 'U';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    // ================================================
    // CREATE / EDIT
    // ================================================
    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
      document.getElementById('userForm').reset();
      document.getElementById('userId').value = '';
      document.getElementById('userCedula').disabled = false;
      document.getElementById('passwordHint').textContent = 'Minimo 6 caracteres (requerido)';
      document.getElementById('userPassword').required = true;
      document.getElementById('userQuota').value = 3;
      openModal('userModal');
    }

    async function editUser(id) {
      try {
        // Find user in current data
        const user = usersData.users.find(u => u.id === id);
        if (!user) {
          showToast('Usuario no encontrado', 'error');
          return;
        }

        document.getElementById('modalTitle').textContent = 'Editar Usuario';
        document.getElementById('userId').value = user.id;
        document.getElementById('userCedula').value = user.cedula || '';
        document.getElementById('userCedula').disabled = true; // Can't change cedula
        document.getElementById('userName').value = user.nombre || '';
        document.getElementById('userEmail').value = user.email || '';
        document.getElementById('userPhone').value = user.telefono || '';
        document.getElementById('userRole').value = user.role || 'user';
        document.getElementById('userActive').value = user.is_active ? 'true' : 'false';
        document.getElementById('userQuota').value = user.quote_limit || 3;
        document.getElementById('userPassword').value = '';
        document.getElementById('userPassword').required = false;
        document.getElementById('passwordHint').textContent = 'Dejar vacio para mantener la actual';

        openModal('userModal');
      } catch (err) {
        console.error('Failed to load user:', err);
        showToast('Error al cargar usuario', 'error');
      }
    }

    async function saveUser(e) {
      e.preventDefault();

      const id = document.getElementById('userId').value;
      const isNew = !id;

      const body = {
        cedula: document.getElementById('userCedula').value,
        nombre: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value || null,
        telefono: document.getElementById('userPhone').value || null,
        role: document.getElementById('userRole').value,
        is_active: document.getElementById('userActive').value === 'true',
        quote_limit: parseInt(document.getElementById('userQuota').value) || 3
      };

      const password = document.getElementById('userPassword').value;
      if (password) {
        if (password.length < 6) {
          showToast('La contrasena debe tener al menos 6 caracteres', 'error');
          return;
        }
        body.password = password;
      } else if (isNew) {
        showToast('La contrasena es requerida para nuevos usuarios', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      try {
        if (isNew) {
          await apiPost('/admin/users', body);
          showToast('Usuario creado exitosamente', 'success');
        } else {
          await apiPut(`/admin/users/${id}`, body);
          showToast('Usuario actualizado exitosamente', 'success');
        }

        closeModal('userModal');
        loadUsers(usersData.page);
      } catch (err) {
        console.error('Failed to save user:', err);
        showToast(err.message || 'Error al guardar usuario', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
      }
    }

    // ================================================
    // DELETE
    // ================================================
    function deleteUser(id, name) {
      deleteUserId = id;
      document.getElementById('deleteUserName').textContent = name || 'este usuario';
      openModal('deleteModal');
    }

    async function confirmDelete() {
      if (!deleteUserId) return;

      try {
        await apiDelete(`/admin/users/${deleteUserId}`);
        showToast('Usuario eliminado', 'success');
        closeModal('deleteModal');
        loadUsers(usersData.page);
      } catch (err) {
        console.error('Failed to delete user:', err);
        showToast(err.message || 'Error al eliminar usuario', 'error');
      }

      deleteUserId = null;
    }

    // ================================================
    // INIT
    // ================================================
    document.addEventListener('DOMContentLoaded', async () => {
      const ready = await initAdmin('users');
      if (ready) {
        loadUsers();
      }
    });
  </script>
</body>
</html>
